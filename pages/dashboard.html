<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/fonditoelegant.png">
  <title>
    COOPSERP | CC Asociados
  </title>
  <!-- Fonts and icons -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Material Icons -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">


  <!-- TU PLANTILLA PRIMERO -->
  <link id="pagestyle" href="../assets/css/material-dashboard.css" rel="stylesheet" />

  <!-- Librerías externas DESPUÉS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables con Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

  <link rel="stylesheet" href="/assets/css/expediente.css">

  <link rel="stylesheet" href="/assets/css/estilosFooter.css">

  <link rel="stylesheet" href="/assets/css/buscarCliente.css">



</head>

<body class="g-sidenav-show  bg-gray-100">
  <div class="min-height-300 position-absolute w-100" style="background-color: #005E56;"></div>
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2  bg-white my-2"
    id="sidenav-main">
    <div class="sidenav-header text-center py-3">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
        aria-hidden="true" id="iconSidenav"></i>

      <!-- Logo grande y centrado -->
      <img src="../assets/img/coopserp.gif" alt="Logo COOPSERP" style="height: 60px; display: block; margin: 0 auto;">

      <!-- Título estilizado -->
      <h6 class="mt-2 mb-0 fw-bold text-success" style="font-size: 1.3rem;">
        Cartera Castigada
      </h6>
    </div>


    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active bg-dark text-white" href="../pages/dashboard.html">
            <i class="material-symbols-rounded opacity-5">dashboard</i>
            <span class="nav-link-text ms-1">Cartera Castigada</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="../pages/resumen.html">
            <i class="material-symbols-rounded opacity-5">table_view</i>
            <span class="nav-link-text ms-1">Cartera Castigada | Resumen</span>
          </a>
        </li>
        <li class="nav-item" id="moduloAuditoria">
          <a class="nav-link text-dark" href="../pages/auditoria.html">
            <i class="fas fa-user-shield opacity-6 me-2"></i>
            <span class="nav-link-text ms-1">Auditoría</span>
          </a>
        </li>
      </ul>
    </div>
    <div class="sidenav-footer position-absolute w-100 bottom-0 ">
      <div class="mx-3">
        <button id="logoutBtn" class="btn bg-gradient-danger w-100 fw-bold" type="button">Cerrar Sesión</button>
      </div>
    </div>
  </aside>
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur"
      data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm text-white fw-bold"><a class="opacity-5 text-white"
                href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-white fw-bold active" aria-current="page">Cartera Castigada</li>
          </ol>
        </nav>

        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <span id="userNameDisplay" class="text-warning fw-bold"></span>
          </div>
        </div>
      </div>
    </nav>

    <!-- End Navbar -->
    <div class="container-fluid">
      <div class="row">
        <div class="d-flex justify-content-between align-items-center px-3">
          <h1 class="mb-0 h4 font-weight-bolder text-white">Cartera Castigada</h1>
          <h4 class="text-white font-weight-bolder" id="fechaCorte"></h4>
        </div>
      </div>
      <div class="row">
        <div class="col d-flex justify-content-end gap-2 px-3">
          <button type="button" class="btn btn-warning btn-md d-flex align-items-center" data-bs-toggle="modal"
            data-bs-target="#modalConceptos">
            <i class="fas fa-info-circle me-2"></i> Medidas Cautelares
          </button>
          <button type="button" class="btn btn-dark btn-md d-flex align-items-center" id="btnCrearGestion"
            data-bs-toggle="modal" data-bs-target="#modalCrearGestion">
            <i class="fas fa-plus me-2"></i> Crear Gestión
          </button>
        </div>
      </div>


      <div class="row mb-4 mt-5">
        <div class="col-lg-12 col-md-6 mb-md-0 mb-4">
          <div class="card">
            <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
              <div
                class="bg-gradient-dark shadow-dark border-radius-lg pt-4 pb-3 d-flex justify-content-between align-items-center">
                <h4 class="text-white text-capitalize ps-3">Asociados Castigados</h4>
                <button id="toggleFiltros" class="btn btn-warning btn-md me-3">
                  <i class="fas fa-filter"></i> Filtros
                </button>
              </div>
            </div>

            <div class="card-body px-0 pb-2">

              <!-- Contenedor de Filtros Oculto -->
              <div class="filtros-container d-none">
                <!-- Primera fila (3 filtros) -->
                <div class="row mb-3 g-2 align-items-end">
                  <div class="col-md-4">
                    <label class="form-label text-dark">Agencias</label>
                    <div class="dropdown w-100">
                      <button class="form-select text-start" type="button" id="dropdownAgencias"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        Seleccionar agencias...
                      </button>
                      <div class="dropdown-menu w-100 p-3" aria-labelledby="dropdownAgencias"
                        style="max-height: 300px; overflow-y: auto;">
                        <div class="form-check mb-2">
                          <input class="form-check-input" type="checkbox" id="selectAllAgencias">
                          <label class="form-check-label fw-bold" for="selectAllAgencias">
                            Seleccionar todas
                          </label>
                        </div>
                        <hr>
                        <div id="checkboxesAgencias"></div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-4">
                    <label for="filtroFechaInicio" class="form-label text-dark">Fecha Castigo (desde)</label>
                    <input type="date" id="filtroFechaInicio" class="form-control">
                  </div>

                  <div class="col-md-4">
                    <label for="filtroFechaFin" class="form-label text-dark">Fecha Castigo (hasta)</label>
                    <input type="date" id="filtroFechaFin" class="form-control">
                  </div>
                </div>

                <!-- Segunda fila (3 filtros + botón al final) -->
                <div class="row mb-3 g-2 align-items-end">
                  <div class="col-md-4">
                    <label for="ordenFecha" class="form-label text-dark">Orden Fecha</label>
                    <select id="ordenFecha" class="form-select">
                      <option value="asc">Más antiguos primero</option>
                      <option value="desc">Más recientes primero</option>
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label for="filtroScore" class="form-label text-dark">Score</label>
                    <select id="filtroScore" class="form-select">
                      <option value="">Todos</option>
                      <option value="SE">S/E</option>
                      <option value="FD">F/D</option>
                      <option value="QEPD">Q.E.P.D</option>
                      <option value="0-650">0 - 650</option>
                      <option value="650+">650+</option>
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label for="ordenValor" class="form-label text-dark">Orden Valor</label>
                    <select id="ordenValor" class="form-select">
                      <option value="">Sin ordenar</option>
                      <option value="asc">Menor a mayor</option>
                      <option value="desc">Mayor a menor</option>
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label for="filtroRecaudacion" class="form-label text-dark">Recaudación</label>
                    <select id="filtroRecaudacion" class="form-select">
                      <option value="">Todos</option>
                      <option value="LEY_INSOLVENCIA">Ley Insolvencia</option>
                      <option value="SALDO_MINIMO">Saldo menor a Salario Mínimo</option>
                      <option value="SIN_MEDIDA_CAUTELAR">Sin Medida Cautelar</option>
                      <option value="CARTERA_PROBLEMA">CC - Problema</option>
                      <option value="EMBARGO_BIENES">CC - Embargo Bien Mueble/Inmueble</option>
                      <option value="EMBARGO_SECUESTRADO">CC - Embargo Bien Secuestrado</option>
                      <option value="CC_REMATE">CC - Remate</option>
                      <option value="SIN_AMNISTIA">CC - Sin Amnistía</option>
                    </select>
                  </div>

                  <!-- Botón borrar filtros -->
                  <div class="col-12 d-flex justify-content-end mt-2">
                    <button id="limpiarFiltros" class="btn btn-danger btn-icon">
                      <i class="fas fa-broom"></i>
                    </button>
                  </div>
                </div>

                <!-- Contenedor de agencias seleccionadas -->
                <div class="row mt-2">
                  <div class="col-12">
                    <div id="agenciasSeleccionadasContainer" class="d-flex flex-wrap gap-2 align-items-center">
                      <span class="text-muted small" id="textoAgencias">Ninguna agencia seleccionada</span>
                    </div>
                  </div>
                </div>

              </div>


              <!-- Tabla -->
              <div class="table-responsive">
                <table id="tablaCastigados" class="table table-striped" style="width:100%">
                  <thead>
                    <tr>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Agencia</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Cedúla</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Nombre</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Cuenta</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Nomina</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Score/Vigencia</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Valor Castigado</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Fecha Castigo</th>
                      <th class="text-center text-uppercase text-dark text-md font-weight-bolder">Acciones</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <footer class="footer py-3">
    <div class="container-fluid">
      <div class="row align-items-center justify-content-lg-between">
        <div class="col-lg-12 text-center">
          <div class="copyright-text" style="font-size: 1.1rem;">
            ©
            <script>document.write(new Date().getFullYear())</script>
            <span class="mx-2">⚡</span>
            <span class="powered-by">DESARROLLADO POR</span>
            <span class="mx-2">⚡</span>
            <span class="guapacha-container">
              <span class="guapacha-badge">
                <!-- <i class="fas fa-crown me-1"></i> -->
                <span class="guapacha-name">COOPSERP</span>
                <!-- <i class="fas fa-bolt ms-1"></i> -->
              </span>
              <div class="lightning-storm"></div>
            </span>
            <span class="mx-2">⚡</span>
            <span class="version">v1.0.0</span>
          </div>
        </div>
      </div>
    </div>
  </footer>



  <div class="modal fade" id="modalDetalleAsociado" tabindex="-1" aria-labelledby="modalDetalleLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="d-flex justify-content-end p-3">
          <button class="btn btn-outline-primary" onclick="imprimirHistorial()">
            <i class="fas fa-print me-2"></i> Imprimir
          </button>
        </div>
        <div class="modal-body">
          <div id="contenidoModalAsociado" class="row gy-3">

          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal Gestión -->
  <div class="modal fade" id="modalGestion" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gestión Jurídica</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="contenidoGestion">

        </div>
      </div>
    </div>
  </div>


  <!-- Modal Conceptos -->
  <div class="modal fade" id="modalConceptos" tabindex="-1" aria-labelledby="modalConceptosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">

        <!-- Header -->
        <div class="modal-header text-white" style="background-color: #005E56;">
          <h5 class="modal-title fw-bold w-100 text-center" id="modalConceptosLabel">
            Conceptos Medidas Cautelares
          </h5>
        </div>


        <!-- Body -->
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
              <thead style="background-color: #E0F2F1;"> <!-- Verde clarito para diferenciar -->
                <tr>
                  <th class="text-center">Código</th>
                  <th class="text-center">Descripción</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="text-center">MC1</td>
                  <td>SALARIOS</td>
                </tr>
                <tr>
                  <td class="text-center">MC2</td>
                  <td>PENSIÓN</td>
                </tr>
                <tr>
                  <td class="text-center">MC3</td>
                  <td>HONORARIOS, BONIFICACIÓN O DEMÁS DOCUMENTOS</td>
                </tr>
                <tr>
                  <td class="text-center">MC4</td>
                  <td>BIENES INMUEBLES</td>
                </tr>
                <tr>
                  <td class="text-center">MC5</td>
                  <td>DERECHOS EN COMÚN Y PROINDIVISO SOBRE EL INMUEBLE</td>
                </tr>
                <tr>
                  <td class="text-center">MC6</td>
                  <td>BIENES MUEBLES</td>
                </tr>
                <tr>
                  <td class="text-center">MC7</td>
                  <td>ESTABLECIMIENTOS DE COMERCIO</td>
                </tr>
                <tr>
                  <td class="text-center">MC8</td>
                  <td>PRESTACIONES SOCIALES</td>
                </tr>
                <tr>
                  <td class="text-center">MC8A</td>
                  <td>PRESTACIONES SOCIALES INCLUIDAS CESANTÍAS</td>
                </tr>
                <tr>
                  <td class="text-center">MC8B</td>
                  <td>PRESTACIONES SOCIALES SIN CESANTÍAS</td>
                </tr>
                <tr>
                  <td class="text-center">MC8C</td>
                  <td>CESANTÍAS</td>
                </tr>
                <tr>
                  <td class="text-center">MC9</td>
                  <td>CUENTAS BANCARIAS</td>
                </tr>
                <tr>
                  <td class="text-center">MC10</td>
                  <td>REMANENTES</td>
                </tr>
                <tr>
                  <td class="text-center">MC11</td>
                  <td>AMPLIACIÓN DE MEDIDA</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>

      </div>
    </div>
  </div>


  <!-- Modal Gestión -->
  <div class="modal fade" id="modalCrearGestion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg border-0 rounded-3">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title fw-bold"><i class="fas fa-tasks me-2"></i> Nueva Gestión</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body p-4">
          <!-- Paso 1: Buscar Cliente -->
          <div class="mb-3">
            <label class="form-label fw-bold">Escriba número de cédula</label>

            <div class="search-container">
              <div class="search-bar shadow-sm">
                <input type="text" id="cedulaInput" class="form-control border-0" placeholder="Ej: 1019059411"
                  aria-label="Número de documento">
                <button class="btn" id="btnBuscarCliente">
                  <i class="fas fa-search"></i>
                </button>
              </div>

              <div class="d-flex justify-content-between mt-2 w-100" style="max-width: 500px;">
                <small class="text-muted">Ejemplo: 1019059411</small>
              </div>
            </div>
          </div>

          <!-- Paso 2: Mostrar Datos Cliente -->
          <div id="datosCliente" class="d-none mt-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h6 class="fw-bold mb-3"><i class="fas fa-user me-2"></i> Información del Asociado</h6>

                <div class="info-grid">
                  <div class="info-item">
                    <strong>Agencia:</strong>
                    <span id="clienteAgencia"></span>
                  </div>

                  <div class="info-item">
                    <strong>Nombre:</strong>
                    <span id="clienteNombre"></span>
                  </div>

                  <div class="info-item">
                    <strong>Cédula:</strong>
                    <span id="clienteCedula"></span>
                  </div>

                  <div class="info-item">
                    <strong>Cuenta:</strong>
                    <span id="clienteCuenta"></span>
                  </div>

                  <div class="info-item">
                    <strong>Nómina:</strong>
                    <span id="clienteNomina"></span>
                  </div>

                  <div class="info-item">
                    <strong>Valor Castigado:</strong>
                    <span id="clienteValorCastigado"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Paso 3: Escribir Gestión -->
          <div id="areaGestion" class="d-none mt-4">
            <label class="form-label fw-bold">Detalle de la Gestión</label>
            <textarea id="textoGestion" class="form-control" rows="5"
              placeholder="Escriba aquí la gestión realizada..."></textarea>
            <small class="text-muted char-counter">0/250 caracteres</small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success d-none" id="btnGuardarGestion">
            <i class="fas fa-save me-2"></i> Guardar Gestión
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- jQuery (necesario para DataTables) -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <!-- DataTables Buttons -->
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <!-- JSZip (Necesario para exportar a Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- En el head de tu HTML -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script src="../js/castigados.js"></script>

  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

  <!--   Core JS Files   -->

  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/chartjs.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const user = sessionStorage.getItem('usuario');
      if (user) {
        const userUpper = user.toUpperCase();
        document.getElementById('userNameDisplay').innerHTML = `Bienvenido, <strong>${userUpper}</strong>`;
      }
    });


    document.getElementById('logoutBtn').addEventListener('click', async function () {
      Swal.fire({
        title: '¿Estás seguro?',
        text: 'Se cerrará la sesión actual.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, cerrar sesión',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6'
      }).then(async (result) => {
        if (result.isConfirmed) {
          const token = sessionStorage.getItem('token');

          try {
            await fetch('http://localhost:5000/api/logout', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
          } catch (error) {
            console.error('Error al cerrar sesión:', error);
          }

          sessionStorage.clear();
          window.location.href = '../pages/sign-in.html';
        }
      });
    });

  </script>


  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/material-dashboard.min.js?v=3.2.0"></script>
</body>

</html>